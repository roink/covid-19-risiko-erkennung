---
title: "Covid19: Google Trends"
author: "Florian Endel"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, cache=FALSE)

rm(list=ls())


## data
library(tidyverse)
library(lubridate)
#library(data.table)

## reading, writing
#library(readr)
#library(vroom)
#library(fst)
library(qs)
#library(arrow)
#library(feather)

## modeling
library(tidymodels)

## Document
library(knitr)
library(kableExtra)  # For nice tables
library(scales)      # For number formatting
library(cowplot)     # For arranging multiple plots

## utils
library(here)

## settings
theme_set(theme_light())


## source helper functions
source(here('src', 'directories_files.R'))
source(here('src', 'helper_functions.R'))

```

```{r setup_gtrends, include=FALSE}

## Google Trends
#library(devtools)
#devtools::install_github("PMassicotte/gtrendsR") # installation from github necessary
library(gtrendsR)
library(forecast)
library(jtools)
library(sandwich)

```


```{r data_kaggle_load}

kaggle <- qread(file = files$kaggle_interim)
model_data <- qread(file = files$kaggle_model_data)

```


# Google Trends Analysis 

To complement our analysis of COVID-19 cases in Mexico, we examine Google search trends that might reflect public interest and concern about the pandemic. We compare search patterns with actual mortality data to understand the relationship between public attention and health outcomes.

## Data Collection

```{r data_gtrends}

# Define search terms by category
covid_terms <- c(
  # Basic COVID terms
  "COVID México",
  "Coronavirus México",
  "Síntomas COVID",      # COVID symptoms
  "Prueba COVID",        # COVID test
  
  # Vaccination related
  "Vacuna COVID",        # COVID vaccine
  "Registro vacuna COVID", # Vaccine registration
  "Efectos vacuna COVID", # Vaccine side effects
  "Sputnik México",      # Specific vaccines used in Mexico
  "Pfizer México",
  
  # Risk factors and health
  "Obesidad COVID",      # Obesity COVID
  "Diabetes COVID",
  "Hipertensión COVID",
  "Factores de riesgo COVID", # Risk factors COVID
  "Oximetro",           # Oximeter (common purchase during COVID)
  
  # Deaths and burials
  "Muertes COVID México", # COVID deaths
  "Funeraria COVID",     # Funeral homes COVID
  "Cremación COVID",     # Cremation COVID
  
  # Restrictions and prevention
  "Semáforo COVID",      # Mexico's COVID traffic light system
  "Cuarentena México",   # Quarantine
  "Cubrebocas",         # Face masks
  "Gel antibacterial",   # Hand sanitizer
  
  # Economic/Social Impact
  "Apoyo COVID México",  # COVID support/aid
  "Desempleo COVID",     # Unemployment COVID
  "Home office México",
  
  # Treatment
  "Tratamiento COVID",   # COVID treatment
  "Hospital COVID",
  "Tanque oxigeno"      # Oxygen tank (critical during shortages)
)

process_trends <- function(trends_result) {
   trends_result$interest_over_time$hits_num = suppressWarnings(
     trends_result$interest_over_time$hits %>%  
       as.numeric() %>% 
       if_else(is.na(.), 0, .)
     )
    trends_result$interest_over_time %>% mutate(
      date = as.Date(date)
    ) %>% 
   select(-hits)
}


# gtrends call to handle multiple batches
# (limit on simultaneous keywords)
get_trends_batch <- function(keywords, geo, time_range, 
                             batch_size=5, wait_time_s=5) {
  # Split keywords into batches of batch_size
  keyword_batches <- split(keywords, ceiling(seq_along(keywords)/batch_size))
  n_batches <- length(keyword_batches)
  
  
  # Get trends for each batch
  all_trends <- imap(keyword_batches, \(batch, idx) {
    if(interactive()){
      message("Batch ", idx, "/", n_batches, "\n Waiting ", wait_time_s, "s")
    }
    Sys.sleep(wait_time_s)  # Add delay to avoid API limits
    if(interactive()){
      message(" Fetching trends for:\n   ", paste(batch, collapse = ", "))
    }
    gtrends(
      keyword = batch,
      time = time_range,
      geo = geo
    )
    if(interactive()){
      message("======================")
    }
  })
  
  return(all_trends)
}


# Download or load existing data
if (!file.exists(files$gtrends_raw)) { 
  # Download data for Mexico (MX) covering the same period as our case data
  trends_raw <- get_trends_batch(
    keywords = covid_terms,
    geo = "MX",
    time_range = "2020-01-01 2021-05-31"
  )
  
  qsave(trends_raw, files$gtrends_raw)
} else {
  trends_raw <- qread(files$gtrends_raw)
}

# Combine results
if (!file.exists(files$gtrends_interim)) {
  trends_data <- trends_raw %>%
    map(process_trends) %>%
    bind_rows()
  
  qsave(trends_data, files$gtrends_interim)
} else {
  trends_data <- qread(files$gtrends_interim)
}


```

## Data Processing

```{r gtrends_wrangle, fig.height=12}
# Add theme categorization
trends_processed <- trends_data %>%
  mutate(
    theme = case_when(
      keyword %in% c("COVID México", "Coronavirus México", 
                    "Síntomas COVID", "Prueba COVID") ~ "Basic Information",
      keyword %in% c("Vacuna COVID", "Registro vacuna COVID", 
                    "Efectos vacuna COVID", "Sputnik México", 
                    "Pfizer México") ~ "Vaccination",
      keyword %in% c("Obesidad COVID", "Diabetes COVID", 
                    "Hipertensión COVID", "Factores de riesgo COVID", 
                    "Oximetro") ~ "Risk Factors",
      keyword %in% c("Muertes COVID México", "Funeraria COVID", 
                    "Cremación COVID") ~ "Mortality",
      keyword %in% c("Semáforo COVID", "Cuarentena México", 
                    "Cubrebocas", "Gel antibacterial") ~ "Prevention",
      keyword %in% c("Apoyo COVID México", "Desempleo COVID", 
                    "Home office México") ~ "Socioeconomic",
      keyword %in% c("Tratamiento COVID", "Hospital COVID", 
                    "Tanque oxigeno") ~ "Treatment",
      TRUE ~ "Other"
    )
  )

# Create theme-based visualizations
ggplot(trends_processed, 
       aes(x = date, y = hits_num, color = keyword)) +
  geom_line(alpha = 0.7) +
  facet_wrap(~theme, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 6)) +
  labs(
    title = "COVID-19 Related Google Searches in Mexico by Theme",
    subtitle = "Trends in different aspects of the pandemic",
    y = "Search Interest (0-100)",
    x = "Date"
  )
```

## Comparison of Search Trends and Mortality

Temporal pattern of COVID-19 deaths in Mexico:

```{r mortality_timeline}
mortality_by_month <- kaggle %>%
  filter(DIED) %>%
  mutate(month = floor_date(DATE_DIED, "month")) %>%
  count(month) %>%
  rename(deaths = n)

ggplot(mortality_by_month, aes(x = month, y = deaths)) +
  geom_line(color = "darkred") +
  geom_smooth(method = "loess", se = FALSE, color = "blue") +
  labs(
    title = "COVID-19 Deaths in Mexico",
    subtitle = "Monthly totals with trend line",
    x = "Month",
    y = "Number of Deaths",
    caption = "Data: Mexican Ministry of Health (SALUD)"
  ) +
  theme_minimal()
```

Google search trends:

```{r gtrends_visualization}
# Plot all search terms
ggplot(trends_processed, aes(x = date, y = hits_num, color = keyword)) +
  geom_line() +
  geom_smooth(se = FALSE) +
  theme_minimal() +
  scale_color_viridis_d() +
  labs(
    title = "COVID-19 Related Google Searches in Mexico",
    subtitle = "Relative search volume over time",
    y = "Search Interest (0-100)",
    x = "Date",
    color = "Search Term"
  ) +
  theme(legend.position = "bottom")
```

## Correlation Analysis

We can examine the relationship between search interest and mortality:

```{r correlation_analysis}
## Correlation Analysis

# Create translation dictionary
term_translations <- c(
  "COVID México" = "COVID Mexico",
  "Coronavirus México" = "Coronavirus Mexico",
  "Síntomas COVID" = "COVID symptoms",
  "Prueba COVID" = "COVID test",
  "Vacuna COVID" = "COVID vaccine",
  "Registro vacuna COVID" = "COVID vaccine registration",
  "Efectos vacuna COVID" = "COVID vaccine side effects",
  "Sputnik México" = "Sputnik Mexico",
  "Pfizer México" = "Pfizer Mexico",
  "Obesidad COVID" = "COVID obesity",
  "Diabetes COVID" = "COVID diabetes",
  "Hipertensión COVID" = "COVID hypertension",
  "Factores de riesgo COVID" = "COVID risk factors",
  "Oximetro" = "Oximeter",
  "Muertes COVID México" = "COVID deaths Mexico",
  "Funeraria COVID" = "COVID funeral homes",
  "Cremación COVID" = "COVID cremation",
  "Semáforo COVID" = "COVID traffic light system",
  "Cuarentena México" = "Quarantine Mexico",
  "Cubrebocas" = "Face masks",
  "Gel antibacterial" = "Hand sanitizer",
  "Apoyo COVID México" = "COVID support Mexico",
  "Desempleo COVID" = "COVID unemployment",
  "Home office México" = "Home office Mexico",
  "Tratamiento COVID" = "COVID treatment",
  "Hospital COVID" = "COVID hospital",
  "Tanque oxigeno" = "Oxygen tank"
)

# Aggregate search data by month for comparison
search_by_month <- trends_processed %>%
  mutate(month = floor_date(date, "month")) %>%
  group_by(month, keyword) %>%
  summarize(mean_interest = mean(hits_num, na.rm = TRUE), .groups = "drop")

# Join with mortality data
combined_data <- search_by_month %>%
  inner_join(mortality_by_month, by = "month")

# Calculate correlations with error handling
correlations <- combined_data %>%
  group_by(keyword) %>%
  summarize(
    correlation = tryCatch(
      cor(mean_interest, deaths, use = "complete.obs"),
      warning = function(w) NA_real_
    ),
    p_value = tryCatch(
      cor.test(mean_interest, deaths)$p.value,
      warning = function(w) NA_real_,
      error = function(e) NA_real_
    ),
    sd_interest = sd(mean_interest, na.rm = TRUE)  # Add SD to check variation
  ) %>%
  filter(!is.na(correlation)) %>%  # Remove terms with no correlation
  filter(sd_interest > 0) %>%      # Remove terms with no variation
  mutate(
    keyword_en = term_translations[keyword],  # Add English translations
    significance = case_when(
      p_value < 0.001 ~ "***",
      p_value < 0.01 ~ "**",
      p_value < 0.05 ~ "*",
      TRUE ~ "ns"
    )
  ) %>%
  arrange(desc(abs(correlation)))

# Display correlations
correlations %>%
  select(
    `Search Term (Spanish)` = keyword,
    `Search Term (English)` = keyword_en,
    `Correlation` = correlation,
    `P-value` = p_value,
    `Significance` = significance
  ) %>%
  mutate(
    across(c(Correlation, `P-value`), ~round(., 3))
  ) %>%
  kable(caption = "Correlations between Search Interest and COVID-19 Deaths") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

## Interpretation

The analysis reveals several interesting patterns in the relationship between Google searches and COVID-19 mortality in Mexico:

1. **Strong Positive Correlations** (r > 0.6, p < 0.01):
   - Unemployment searches showed the strongest correlation (r = 0.900), suggesting a strong parallel between the health and economic impact of the pandemic
   - Searches for risk factors (r = 0.815) increased alongside mortality, indicating growing public health awareness
   - Death-related searches (r = 0.635) and face mask queries (r = 0.632) closely tracked actual mortality patterns

2. **Moderate Correlations** (0.3 < r < 0.6, not significant):
   - Health-related terms like symptoms, hospital information, and oximeter showed moderate positive correlations
   - These patterns suggest ongoing public health information seeking throughout the pandemic

3. **Vaccine-Related Patterns**:
   - Interestingly, vaccine-related searches showed negative correlations with mortality
   - This might reflect the timing of vaccination campaigns, which began as mortality rates were declining
   - The negative correlations for vaccine side effects (-0.345) and registration (-0.267) suggest these became prominent topics in later phases of the pandemic

4. **Prevention and Treatment**:
   - Basic prevention terms (hand sanitizer, face masks) showed varying correlations
   - Treatment-related searches showed weak to moderate correlations, possibly indicating consistent information seeking regardless of mortality rates

## Limitations

- Google Trends data represents only internet users, which might not be representative of the entire Mexican population, particularly in rural or less connected areas
- Search patterns might be influenced by media coverage and public health campaigns rather than direct experience with COVID-19
- The relative nature of Google Trends data (0-100 scale) makes absolute comparisons between terms difficult
- Search behavior might differ across regions within Mexico, while our mortality data is national
- Correlation doesn't imply causation; many other factors influence both search behavior and mortality rates
- Some important search terms might show no variation (zero standard deviation) and were thus excluded from the analysis
- The timing of searches might reflect both anticipatory behavior (searching before getting sick) and reactive behavior (searching after infection)

## Time Series Analysis of Search Trends

To better understand the temporal patterns in COVID-19 related searches, we perform a time series decomposition and impact analysis focusing on the initial pandemic period.

### Seasonal Decomposition

First, let's examine the underlying patterns in search behavior before the pandemic:

```{r ts_decomposition}
library(forecast)
library(jtools)  # for summ function

# Create time series for pre-pandemic period
ts_in <- trends_processed %>%
  filter(date >= '2020-01-01' & date <= '2021-05-31',
         keyword == "COVID México") %>%  # or another key term
  arrange(date) %>%
  select(hits_num) %>%
  pull()

covid_ts <- ts(ts_in, start = c(2019, 1), frequency = 12)

# Decompose the time series
dcp <- mstl(covid_ts, s.window = "periodic")

# Plot decomposition
autoplot(dcp) +
  labs(title = "Multiple Seasonal Decomposition of COVID-19 Search Queries",
       subtitle = "Trend, Seasonal, and Random Components")

# Check autocorrelation
ggAcf(covid_ts) +
  labs(title = "Autocorrelation Plot (COVID-19 Search Queries)")
```

### Impact Analysis

We now assess whether specific events (like lockdown implementation) are statistically associated with changes in search patterns:

```{r impact_analysis}
# Prepare data for impact analysis
data_impact <- trends_processed %>%
  filter(keyword == "COVID México",  # or another key term
         date <= '2021-05-31') %>%
  arrange(date) %>%
  mutate(
    time = row_number() - 1,  # time index starting at 0
    month = as.factor(month(date)),
    hits_l1 = lag(hits_num),
    # Define treatment period (e.g., first major outbreak or lockdown)
    after = if_else(date >= as.Date('2020-03-01'), 1, 0),
    tau = min(ifelse(after == 1, time, NA_integer_), na.rm = TRUE),
    time_diff = time - tau,
    A_TimeDiff = after * time_diff
  )

# Fit segmented regression
lm_out <- lm(log(hits_num + 1) ~ time + month + after + A_TimeDiff, 
             data = data_impact)

# Calculate percentage change
ipct_out <- round(exp(coef(lm_out)["A_TimeDiff"]) * 100 - 100, 3)

# Display results with Newey-West standard errors
summ(lm_out, 
     vcov = NeweyWest(lm_out, lag = 3, prewhite = TRUE, adjust = TRUE), 
     digits = 3)
```
### Interpretation of Time Series Analysis

The decomposition and regression analysis reveal several key patterns in COVID-19 related searches:

1. **Trend Component**: 
   - The data shows a sharp increase in early 2020, coinciding with the pandemic's onset
   - After the initial spike, search interest stabilized at a higher level than pre-pandemic
   - A gradual declining trend is visible from 2022 onwards

2. **Seasonal Pattern**:
   - Clear monthly seasonality is present in the data
   - Strongest negative seasonal effects in late summer/fall (August-November)
   - The seasonal component shows regular fluctuations with approximately 0.6 unit amplitude

3. **Impact Analysis Results**:
   - **Immediate Effect**: A significant level shift occurred after the intervention (β = 1.220, p = 0.003), indicating an immediate 239% increase (e^1.220 - 1) in search intensity
   - **Trend Change**: The negative interaction term (β = -0.057, p = 0.028) suggests a gradual decline in the intervention effect over time
   - **Monthly Effects**: Strongest seasonal decreases in August through November (significant at p < 0.01)
   - The model explains a substantial portion of the variance (R² = 0.773)

4. **Autocorrelation Structure**:
   - Strong positive autocorrelation in the first 4-5 lags
   - Negative autocorrelation at longer lags
   - This pattern suggests short-term persistence in search behavior followed by periodic reversals

### Practical Implications

1. **Public Health Communication**:
   - The strong immediate effect suggests high initial public interest/concern
   - The declining trend indicates a possible "pandemic fatigue" in information seeking
   - Seasonal patterns could be used to time public health messaging

2. **Policy Relevance**:
   - The gradual decline in effect (-5.7% per month) suggests a normalization of information-seeking behavior
   - Seasonal variations should be considered when interpreting search patterns
   - The high R² indicates that the model captures the major drivers of search behavior

### Limitations

- The analysis period might be too short to establish robust seasonal patterns
- The model assumes linear trends which might not fully capture the complexity of public response
- Search patterns might reflect media coverage rather than actual health concerns
- The presence of strong autocorrelation suggests possible omitted time-varying factors

